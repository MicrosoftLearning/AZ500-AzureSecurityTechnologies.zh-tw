---
lab:
  title: 03 - Azure 防火牆
  module: Module 02 - Plan and implement security for public access to Azure resources
---

# 實驗室 03：Azure 防火牆
# 學生實驗室手冊

## 實驗案例

您收到安裝 Azure 防火牆的要求。 這麼做能協助組織控制輸入及輸出網路存取，其為整體網路安全性方案中的重要部分。 具體而言，您要建立並測試下列基礎結構元件：

- 虛擬網路，具有工作負載子網路和跳躍主機子網路。
- 每個子網路一部虛擬機器。 
- 自訂路由，確保來自工作負載子網路的所有輸出工作負載流量都必須使用防火牆。
- 防火牆應用程式規則，只允許對 www.bing.com 的輸出流量。 
- 允許外部 DNS 伺服器查閱的防火牆網路規則。

> 此實驗室中所有資源均使用**美國東部**區域。 請與講師驗證這是課程中要使用的區域。 

## 實驗室目標

在本實驗室中，您須完成下列練習：

- 練習 1：部署及測試 Azure 防火牆

## Azure 防火牆圖表

![image](https://user-images.githubusercontent.com/91347931/157529954-a1bc434b-2eca-41c1-b875-1f0c977d5e20.png)

## 指示

## 實驗室檔案：

- **\\Allfiles\\Labs\\08\\template.json**

### 練習 1：部署及測試 Azure 防火牆

### 預估時間：40 分鐘

> 此實驗室中所有資源均使用**美國東部**區域。 請與講師確認這是課程中要使用的區域。 

在本練習中，您將會完成下列工作：

- 工作 1：使用範本來部署實驗室環境。 
- 工作 2：部署 Azure 防火牆。
- 工作 3：建立預設路由。
- 工作 4：設定應用程式規則。
- 工作 5：設定網路規則。 
- 工作 6：設定 DNS 伺服器。
- 工作 7：測試防火牆。 

#### 工作 1：使用範本來部署實驗室環境。 

在此工作中，您必須檢閱並部署實驗室環境。 

在這項工作中，您必須使用 ARM 範本建立虛擬機器。 本實驗室的最後一項練習會使用此虛擬機器。 

1. 登入 Azure 入口網站：**`https://portal.azure.com/`**。

    >**注意**：使用您用於此實驗室之 Azure 訂用帳戶中擁有擁有者或參與者角色的帳戶登入 Azure 入口網站。

2. 在 Azure 入口網站頁面頂端的 [搜尋資源、服務及文件] 文字輸入框中輸入****「部署自訂範本」****，然後按下 **Enter** 鍵。

3. 在 [自訂部署****] 刀鋒視窗中按一下 ****[在編輯器中建置您自己的範本] 選項。

4. 在 [編輯範本]**** 刀鋒視窗中按一下 [載入檔案]****，找出 **\\Allfiles\\Labs\\08\\template.json** 檔案，然後按一下 [開啟]****。

    >**注意**：請檢閱範本內容，並注意範本所部署的是裝載 Windows Server 2016 Datacenter 的 Azure VM。

5. 在 [編輯範本****] 刀鋒視窗中按一下 [儲存****]。

6. 在 [自訂部署****] 刀鋒視窗中，確認已指定下列設定 (其他設定請保留預設值)：

   |設定|值|
   |---|---|
   |訂用帳戶|您要在此實驗室中使用的 Azure 訂閱名稱|
   |資源群組|按一下 [新建]****，然後輸入以下名稱：**AZ500LAB08**|
   |Location|**(美國) 美國東部**|
   |adminPassword|您自己為虛擬機選擇的安全密碼。 請記住密碼。 您稍後將需要它才能連線到 VM。|

    >**注意**：若要識別您可以布建 Azure VM 的 Azure 區域，請參閱 [**https://azure.microsoft.com/en-us/regions/offers/**](https://azure.microsoft.com/en-us/regions/offers/)

7. 按一下 [檢閱 + 建立]****，然後按一下 [建立]****。

    >**注意**：等待部署完成。 這應該大約需要 2 分鐘的時間。 

#### 工作 2：部署 Azure 防火牆

在此工作中，您必須將 Azure 防火牆部署至虛擬網路。 

1. 在 Azure 入口網站分頁頂端的 [搜尋資源、服務及文件] **** 文字輸入框中輸入 **「防火牆」**，然後按下 **Enter** 鍵。

2. 在 [防火牆]**** 刀鋒視窗上，按一下 [+ 建立]****。

3. 在 [建立防火牆]**** 刀鋒視窗的 [基本]**** 索引標籤上，指定下列設定 (其他設定請保留預設值)：

   |設定|值|
   |---|---|
   |資源群組|**AZ500LAB08**|
   |名稱|**Test-FW01**|
   |區域|**(美國) 美國東部**|
   |防火牆 SKU|**標準**|
   |防火牆管理|**使用防火牆規則 (傳統) 管理此防火牆**|
   |選擇虛擬網路|按一下 [使用現有項目]**** 選項，然後在下拉式清單中選取 [Test-FW-VN]****|
   |公用 IP 位址|按一下 [新增] **** 並在名稱部分輸入 **TEST-FW-PIP**，然後按一下 [確定]****|

4. 按一下 [檢閱 + 建立]  ，然後按一下 [建立]  。 

    >**注意**：等待部署完成。 這應該大約需要 5 分鐘的時間。 

5. 在 Azure 入口網站分頁頂端的 [搜尋資源、服務及文件]**** 文字輸入框中輸入 **「資源群組」**，然後按下 **Enter** 鍵。

6. 在 [資源群組]**** 刀鋒視窗的資源群組清單中，按一下 [AZ500LAB08]**** 項目。

    >**注意**：在 **[AZ500LAB08資源群組]** 刀鋒視窗中，檢閱資源清單。 您可以依**型別**排序。

7. 在資源清單中，按一下代表 **Test-FW01** 防火牆的項目。

8. 在 [Test-FW01]**** 刀鋒視窗中，找出先前指派給防火牆的**私人 IP** 位址。 

    >**注意**：在下一個工作中，您將需要此資訊。


#### 工作 3：建立預設路由

在此工作中，您必須為 **Workload-SN** 子網路建立預設路由。 此路由會設定透過防火牆輸出的流量。

1. 在 Azure 入口網站分頁頂端的 [搜尋資源、服務及文件] **** 文字輸入框中輸入 **「路由表」**，然後按下 **Enter** 鍵。

2. 在 [路由表]**** 刀鋒視窗中按一下 [+ 建立]****。

3. 在 [建立路由表]**** 刀鋒視窗中指定下列設定：

   |設定|值|
   |---|---|
   |資源群組|**AZ500LAB08**|
   |區域| **美國東部**|
   |名稱|**防火牆路由**|

4. 按一下 [檢閱 + 建立]****，再點選 [建立]****，然後等待佈建完成。 

5. 在 [路由表]**** 刀鋒視窗中按一下 [重新整理]****，然後在路由表清單中點選 [防火牆路由]**** 項目。

6. 在 [防火牆路由]**** 刀鋒視窗的 [設定]**** 區段按一下 [子網路]****，然後在 [防火牆路由 \| 子網路]**** 刀鋒視窗中按一下 [+ 關聯]****。

7. 在 [關聯子網路]**** 刀鋒視窗中，指定下列設定：

   |設定|值|
   |---|---|
   |虛擬網路|**Test-FW-VN**|
   |子網路|**Workload-SN**|

    >**注意**：請確定 **已為此路由選取 Workload-SN** 子網，否則防火牆將無法正常運作。

8. 按一下 [確定]****，為防火牆和虛擬網路子網路建立關聯。 

9. 返回 [防火牆路由]**** 刀鋒視窗，在[設定]**** 區段中按一下 [路由]****，然後點選 [+ 新增]****。 

10. 在 [新增路由]**** 刀鋒視窗中，指定下列設定：  

   |設定|值|
   |---|---|
   |路由名稱|**FW-DG**|
   |位址首碼目的地|**IP 位址**|
   |目的地 IP 位址/CIDR 範圍|**0.0.0.0/0**
   |下一個躍點類型|**虛擬設備**|
   |下一個躍點位址|您在上一項工作中找出的防火牆私人 IP 位址|

    >**注意**：Azure 防火牆 實際上是受控服務，但虛擬設備在此情況下運作。
    
11.  按一下 [新增]**** 新增路由。 


#### 工作 4：設定應用程式規則

在此工作中，您必須建立應用程式規則，允許對 `www.bing.com` 的輸出存取。

1. 在Azure 入口網站中，返回 [Test-FW01] **** 防火牆。

2. 在 [Test-FW01]**** 刀鋒視窗的 [設定]**** 區段中，按一下 [規則 (傳統)]****。

3. 在 [Test-FW01 \| 規則 (傳統)]**** 刀鋒視窗中按一下 [應用程式規則集合]**** 索引標籤，然後點選 [+ 新增應用程式規則集合]****。

4. 在 [新增應用程式規則集合]**** 刀鋒視窗中指定下列設定 (其他設定請保留預設值)：

   |設定|值|
   |---|---|
   |名稱|**App-Coll01**|
   |優先順序|**200**|
   |動作|**允許**|

5. 在 [新增應用程式規則集合]**** 刀鋒視窗中，使用下列設定在 [目標 FQDN]**** 區段建立新項目 (其他設定請保留預設值)：

   |設定|值|
   |---|---|
   |NAME|**AllowGH**|
   |來源類型|**IP 位址**|
   |來源|**10.0.2.0/24**|
   |通訊協定連接埠|**http:80、https:443**|
   |目標 FQDN|**www.bing.com**|

6. 按一下 [新增]****，新增以目標 FQDN 為基礎的應用程式規則。

    >**注意**：Azure 防火牆 包含默認允許之基礎結構 FQDN 的內建規則集合。 這些 FQDN 為平台所特有，無法用於其他用途。 

#### 工作 5：設定網路規則

在此工作中，您必須建立網路規則，以允許對連接埠 53 (DNS) 上兩組 IP 位址的輸出存取。

1. 在 Azure 入口網站中，返回 [Test-FW01 \| 規則 (傳統)] **** 刀鋒視窗。

2. 在 [Test-FW01 \| 規則 (傳統)]**** 刀鋒視窗中按一下 [網路規則集合]**** 索引標籤，再點選 [+ 新增網路規則集合]****。

3. 在 [新增網路規則集合]**** 刀鋒視窗中指定下列設定 (其他設定請保留預設值)：

   |設定|值|
   |---|---|
   |名稱|**Net-Coll01**|
   |優先順序|**200**|
   |動作|**允許**|

4. 在 [新增網路規則集合]**** 刀鋒視窗中，使用下列設定在 [IP 位址]**** 區段建立新項目 (其他設定請保留預設值)：

   |設定|值|
   |---|---|
   |名稱|**AllowDNS**|
   |通訊協定|**UDP**|
   |來源類型|**IP 位址**|
   |來源位址|**10.0.2.0/24**|
   |目的地類型|**IP 位址**|
   |目的地位址|**209.244.0.3,209.244.0.4**|
   |目的地連接埠|**53**|

5. 按一下 [新增]**** 新增網路規則。

    >**注意**：此案例中使用的目的地位址是已知的公用 DNS 伺服器。 

#### 工作 6：設定虛擬機器 DNS 伺服器

在此工作中，您必須為虛擬機器設定主要和次要 DNS 位址。 這並非防火牆的需求。 

1. 在Azure 入口網站中，返回 **AZ500LAB08** 資源群組。

2. 在 [AZ500LAB08]**** 刀鋒視窗的資源清單中，按一下 [Srv-Work]**** 虛擬機器。

3. 在 [Srv-Work]**** 刀鋒視窗的 [設定]**** 區段按一下 [網路]****。

4. 在 [Srv-Work \| 網路]**** 刀鋒視窗中按一下 [網路介面]**** 項目旁邊的連結。

5. 在網路介面刀鋒視窗的 **[設定**] 區段中，按兩下 [**DNS 伺服器]，選取 **[自定義**] 選項，新增網络規則中參考的兩部 DNS 伺服器**：**209.244.0.3** 和 **209.244.0.4**，然後按兩下 **[儲存**] 以儲存變更。

6. 返回 [Srv-Work]**** 虛擬機器分頁。

    >**注意**：等候更新完成。

    >**注意**：更新網路介面的 DNS 伺服器會自動重新啟動該介面所連結的虛擬機，如果適用的話，相同可用性設定組中的任何其他虛擬機。

#### 工作 7：測試防火牆

在此工作中，您必須測試防火牆，確定其能如預期運作。

1. 在Azure 入口網站中，返回 **AZ500LAB08** 資源群組。

2. 在 [AZ500LAB08]**** 刀鋒視窗的資源清單中，按一下 [Srv-Work]**** 虛擬機器。

3. 在 [Srv-Jump]**** 刀鋒視窗中按一下 [連線]****，然後在下拉式功能表中點選 [RDP]****。 

4. 按一下 [下載 RDP 檔案]****，然後使用該檔案透過遠端桌面連線至 **Srv-Jump** Azure VM。 出現驗證提示時，請提供下列認證：

   |設定|值|
   |---|---|
   |使用者名稱|**localadmin**|
   |密碼|您在工作 1 步驟 6 中部署自訂範本時所選擇的安全密碼。|

    >**注意**：下列步驟是在 Srv-Jump** Azure VM 的**遠端桌面會話中執行。 

    >**注意**：您將連線到 **Srv-Work** 虛擬機。 這樣才能測試存取 bing.com 網站的能力。  

5. 在連線至 **Srv-Jump** 的遠端桌面工作階段中，以滑鼠右鍵按一下 [開始]****，然後在右鍵功能表中點選 [執行]****。在 [執行]**** 對話方塊中執行下列命令，以連線至 **Srv-Work**。 

    ```
    mstsc /v:Srv-Work
    ```

6. 出現驗證提示時，請提供下列認證：

   |設定|值|
   |---|---|
   |使用者名稱|**localadmin**|
   |密碼|您在工作 1 步驟 6 中部署自訂範本時所選擇的安全密碼。|

    >**注意**：等候建立遠端桌面會話，以及要載入 伺服器管理員 介面。

7. 在連線至 **Srv-Work** 的遠端桌面工作階段中，於 [伺服器管理員]**** 內按一下 [本機伺服器]****，然後點選 [IE 增強式安全性設定]****。

8. 在 [Internet Explorer 增強式安全性設定****] 對話方塊中將兩個選項都設定為 [關閉****]，然後按一下 [確定****]。

9. 在連線至 **Srv-Work** 的遠端桌面工作階段中啟動 Internet Explorer，並瀏覽至 **`https://www.bing.com`**。 

    >**注意**：網站應該已成功顯示。 防火牆會允許您存取網站。

10. 瀏覽至 **`http://www.microsoft.com/`**

    >**注意**：在瀏覽器頁面中，您應該會收到一則訊息，其文字如下： `HTTP request from 10.0.2.4:xxxxx to microsoft.com:80. Action: Deny. No rule matched. Proceeding with default action.` 這是預期的，因為防火牆會封鎖此網站的存取。 

11. 終止這兩個遠端桌面工作階段。

> 結果：您已成功設定及測試 Azure 防火牆。

**清除資源**

> 請記得移除您不再使用的任何新建立的 Azure 資源。 移除未使用的資源可避免產生非預期的費用。 

1. 在 Azure 入口網站中按一下右上方的第一個圖示，開啟 Cloud Shell。 如果出現提示，請點選 [PowerShell]**** 與 [建立儲存體]****。

2. 確認在 [Cloud Shell] 窗格左上角的下拉式功能表中，已選取 [PowerShell]****。

3. 在 [Cloud Shell] 窗格的 PowerShell 工作階段中，執行下列操作，移除您在此實驗室中建立的資源群組：
  
    ```powershell
    Remove-AzResourceGroup -Name "AZ500LAB08" -Force -AsJob
    ```
4. 關閉 [Cloud Shell] 窗格。 
