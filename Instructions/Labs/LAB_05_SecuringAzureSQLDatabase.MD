---
lab:
  title: 05 - 保護 Azure SQL 資料庫
  module: Module 02 - Plan and implement security for Azure SQL Database and Azure SQL Managed Instance
---

# 實驗室 05：保護 Azure SQL 資料庫
# 學生實驗室手冊

## 實驗案例

系統要求您檢閱 Azure SQL 資料庫的安全性功能。 具體而言，您要關注的是：

- 防止攻擊，例如 SQL 插入式攻擊和資料外流。 
- 能夠探索資料庫資訊並將其分類為不同類別，例如機密。 
- 能夠稽核資料庫伺服器、資料庫查詢和記錄事件。 

> 此實驗室中所有資源均使用**美國東部**區域。 請與講師驗證這是課程中要使用的區域。 

## 實驗室目標

在本實驗室中，您須完成下列練習：

- 練習 1：實作SQL 資料庫安全性功能

## 保護 Azure SQL Database 圖表

![image](https://user-images.githubusercontent.com/91347931/157533836-7250fa58-a109-4882-a55b-d3fa3baf34ab.png)

## 指示

## 實驗室檔案：

- **\\Allfiles\\Labs\\11\\azuredeploy.json**

### 練習 1：實作SQL 資料庫安全性功能

### 預估時間：30 分鐘

在本練習中，您將會完成下列工作：

- 工作 1：部署 Azure SQL 資料庫
- 工作 2：設定進階資料保護
- 工作 3：設定資料分類
- 工作 4：設定稽核

#### 工作 1：部署 Azure SQL 資料庫

在這項工作中，您將使用範本來部署實驗室基礎結構。 

1. 登入 Azure 入口網站：**`https://portal.azure.com/`**。

    >**注意 ** ：使用在您要用於此實驗室的 Azure 訂用帳戶中具有擁有者或參與者角色的帳戶登入Azure 入口網站。

2. 在 Azure 入口網站頁面頂端的 [搜尋資源、服務及文件] 文字輸入框中輸入****「部署自訂範本」****，然後按下 **Enter** 鍵。

3. 在 [自訂部署****] 刀鋒視窗中按一下 ****[在編輯器中建置您自己的範本] 選項。

4. 在 [編輯範本]**** 刀鋒視窗中按一下 [載入檔案]****，找出 **\\Allfiles\\Labs\\11\\azuredeploy.json** 檔案，然後按一下 [開啟]****。

    >**注意 ** ：檢閱範本的內容，並注意其部署 Azure SQL 資料庫。

5. 在 [編輯範本****] 刀鋒視窗中按一下 [儲存****]。

6. 在 [自訂部署****] 刀鋒視窗中，確認已指定下列設定 (其他設定請保留預設值)：

   |設定|值|
   |---|---|
   |訂用帳戶|您要在此實驗室中使用的 Azure 訂閱名稱|
   |資源群組|按一下 [新建]****，然後輸入以下名稱：**AZ500LAB11**|
   |Location|**(美國) 美國東部**|

7. 按一下 [檢閱 + 建立]，然後按一下 [建立]。

    >**注意**：等待部署完成。 

#### 工作 2：設定進階資料保護

1. 在 Azure 入口網站分頁頂端的 [搜尋資源、服務及文件]**** 文字輸入框中輸入 **「資源群組」**，然後按下 **Enter** 鍵。

2. 在 [資源群組]**** 刀鋒視窗的資源群組清單中，按一下 [AZ500LAB11]**** 項目。

3. 在 [AZ500LAB11]**** 刀鋒視窗上，按一下代表新建 SQL Server 的項目。

4. 在 [SQL 伺服器] 刀鋒視窗的 [安全性]**** 區段中，按一下 [適用於雲端的 Microsoft Defender]****，選取 [啟用適用於 SQL 的 Microsoft Defender]****。

      >**注意 ** ：等候通知指出已成功啟用適用于 SQL 的 Azure Defender。

5. 在 [SQL Server] 刀鋒 ** 視窗的 [安全性 ** ] 區段 ** 的 [適用於雲端的 Microsoft Defender] ** 頁面上，于 ** [適用于 SQL 的 Microsoft Defender： 在訂用帳戶層級 [設定] ** 參數上啟用，按一下 ** [設定] ** 。  

      >**注意 ** ：如果 ** [設定] ** 未顯示，請重新整理瀏覽器。
    
6. 在 [伺服器設定]**** 刀鋒視窗上，檢閱定價和試用期間、**弱點評定設定**和**進階威脅防護設定**的相關資訊。

7. 回到 [適用於雲端的 Microsoft Defender]**** 刀鋒視窗，檢閱 [建議]**** 和 [安全性警示]****。

      >**注意 ** ：建議可能需要 10-15 分鐘才會出現在 ** [適用於雲端的 Microsoft Defender] ** 刀鋒視窗中。 您可以繼續進行下一項工作而不必等待，但當您完成所有剩餘工作之後，請考慮返回此刀鋒視窗。


#### 工作 3：設定資料分類

在這項工作中，您將探索並分類 SQL 資料庫中的資訊，以滿足 GPDR 和資料保護合規性。

1. 在 [SQL 伺服器] 刀鋒視窗的 [設定]**** 區段中，按一下 [SQL 資料庫]****。

2. 在資料庫清單中，選擇 [AZ500LabDb]**** 項目。 

3. 在 [AZ500LabDb]**** SQL 資料庫刀鋒視窗的 [安全性]**** 區段中，按一下 [資料探索與分類]****。

4. 在 [資料探索與分類]**** 刀鋒視窗上，按一下 [分類]**** 索引標籤。

    >**注意 ** ：分類引擎會掃描資料庫是否有包含潛在敏感性資料的資料行，並提供建議的資料行分類清單。

5. 按一下顯示在刀鋒視窗頂端藍色橫條上的 [找到 15 行具有分類建議的資料行]**** 文字簡訊。

6. 檢閱列出的資料行和建議的敏感度標籤。 

7. 啟用 [全選]**** 核取方塊，然後按一下 [接受選取的建議]****。

    >**注意 ** ：或者，您可以只選取特定資料行並關閉其他資料行。 

    >**注意 ** ：您可以選擇變更資訊類型和敏感度標籤。 

8. 完成檢閱之後，按一下 [儲存]****。 

    >**注意 ** ：這會完成分類，並持續使用新的分類元資料標記資料庫資料行。 

9. 回到 [資料探索與分類]**** 刀鋒視窗的 [概觀]**** 索引標籤上，請注意該索引標籤已更新以說明最新的分類資訊。 

#### 工作 4：設定稽核 

在這項工作中，您會先設定伺服器層級的稽核，然後設定資料庫層級的稽核。 

1. 在 Azure 入口網站中返回 [SQL Server] 刀鋒視窗。

2. 在 [SQL Server] 刀鋒視窗的 [安全性]**** 區段中，按一下 [稽核]****。

    >**注意 ** ：這是伺服器層級稽核。 預設稽核設定包含針對資料庫執行的所有查詢和預存程序，以及成功和失敗的登入。

3. 將 [啟用 Azure SQL 稽核]**** 開關設定為 [開啟]**** 以啟用稽核。 

4. 選取 [儲存體]**** 核取方塊和 [訂用帳戶]**** 的輸入框，[儲存體帳戶] **** 便會顯示。

5. 從下拉式清單中選擇您的 [訂用帳戶]****。

6. 按一下 [儲存體帳戶]****，然後選擇 [新建]****。

7. 在 [建立儲存體帳戶]**** 刀鋒視窗的 [名稱]**** 方塊中，輸入由 3 到 24 個小寫字母和數字組成的全域唯一名稱，按一下 [確定]****， 

    >**注意 ** ：您可能需要重新整理瀏覽器，才能使用儲存體帳戶。

8. 回到 [稽核]**** 刀鋒視窗的 [進階屬性]**** 下方，將 [保留 (天數)]**** 設定為 **5**。 

9. 在 [稽核] 刀鋒視窗上，按一下 [儲存]**** 以儲存稽核設定。 

    >**注意 ** ：如果您收到有關無效儲存體容器路徑的錯誤訊息，則儲存體帳戶可能尚未布建。 等候幾分鐘，按一下 [儲存體帳戶]****，在 [選擇儲存體帳戶]**** 刀鋒視窗中選取新建的儲存體帳戶，然後回到 [稽核] 刀鋒視窗上按一下 [儲存]****。

10. 在伺服器刀鋒視窗的 [設定]**** 區段中，按一下 [SQL 資料庫]****。

11. 在資料庫清單中，選擇 [AZ500LabDb]**** 項目。 

12. 在 [AZ500LabDb]**** SQL 資料庫刀鋒視窗的 [安全性]**** 區段中，按一下 [稽核]****。 

    >**注意 ** ：這是資料庫層級稽核。 伺服器層級的稽核已啟用。 
  
    >**注意 ** ：稽核可以寫入 Azure 儲存體帳戶、Log Analytics 工作區或事件中樞。 您可以設定這些選項的任何組合。

    >**注意 ** ：如果伺服器上已啟用儲存體型稽核，無論資料庫設定為何，它一律會套用至資料庫。
13. 在Azure 入口網站的 SQL 資料庫 [概觀] 頁面上，從左側功能表中選取 ** [查詢編輯器] [預覽 ** ]。 嘗試登入，您可能會在密碼、IP 位址的防火牆規則上失敗，所有專案都會經過稽核。 嘗試成功登入、執行查詢，而且您可能會在稽核記錄中找到更多稽核記錄

14. 切換回 DB、稽核，然後按一下 [ ** 檢視稽核記錄 ** ]。

15. 請注意，在 [稽核記錄]**** 刀鋒視窗中，您可以在 [伺服器稽核] 和 [資料庫稽核] 之間切換。 

> 結果：您已建立 SQL Server 和資料庫、設定的資料分類和稽核。 


**清除資源**

> 請記得移除您不再使用的任何新建立的 Azure 資源。 移除未使用的資源可避免產生非預期的費用。 

1. 在 Azure 入口網站中按一下右上方的第一個圖示，開啟 Cloud Shell。 如果出現提示，請點選 [PowerShell]**** 與 [建立儲存體]****。

2. 確認在 [Cloud Shell] 窗格左上角的下拉式功能表中，已選取 [PowerShell]****。

3. 在 [Cloud Shell] 窗格的 PowerShell 工作階段中，執行下列操作，移除您在此實驗室中建立的資源群組：
  
    ```powershell
    Remove-AzResourceGroup -Name "AZ500LAB11" -Force -AsJob
    ```
4. 關閉 [Cloud Shell] 窗格。 
