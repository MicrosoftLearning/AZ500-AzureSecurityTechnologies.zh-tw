---
lab:
  title: 08 - Azure 防火牆
  module: Module 02 - Implement Platform Protection
ms.openlocfilehash: 1657a251f1355150d6386f8793825369be955705
ms.sourcegitcommit: e9389f8de66fec6d456a3f303bd350e380df7ff2
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/04/2022
ms.locfileid: "145195843"
---
# <a name="lab-08-azure-firewall"></a>實驗室 08：Azure 防火牆
# <a name="student-lab-manual"></a>學生實驗室手冊

## <a name="lab-scenario"></a>實驗案例

您收到安裝 Azure 防火牆的要求。 防火牆能協助貴組織控管輸入及輸出網路存取，是整體網路安全性方案中重要的一環。 具體而言，您必須建立並測試下列基礎結構元件：

- 含有工作負載子網路和跳板機子網路的虛擬網路。
- 各個子網路使用的虛擬機器。 
- 自訂路由，確保來自工作負載子網路的所有輸出工作負載流量都必須使用防火牆。
- 只允許輸出流量至 www.bing.com 的防火牆應用程式規則。 
- 允許外部 DNS 伺服器查閱的防火牆網路規則。

> 此實驗室中所有資源均使用 **美國東部** 區域。 請與講師確認這是課程中要使用的區域。 

## <a name="lab-objectives"></a>實驗室目標

在本實驗室中，您須完成下列練習：

- 練習 1：部署並測試 Azure 防火牆

## <a name="azure-firewall-diagram"></a>Azure 防火牆圖表

![image](https://user-images.githubusercontent.com/91347931/157529954-a1bc434b-2eca-41c1-b875-1f0c977d5e20.png)

## <a name="instructions"></a>指示

## <a name="lab-files"></a>實驗室檔案：

- **\\Allfiles\\Labs\\08\\template.json**

### <a name="exercise-1-deploy-and-test-an-azure-firewall"></a>練習 1：部署並測試 Azure 防火牆

### <a name="estimated-timing-40-minutes"></a>預估時間：40 分鐘

> 此實驗室中所有資源均使用 **美國東部** 區域。 請與講師確認這是課程中要使用的區域。 

在本練習中，您將會完成下列工作：

- 工作 1：使用範本部署實驗室環境。 
- 工作 2：部署 Azure 防火牆。
- 工作 3：建立預設路由。
- 工作 4：設定應用程式規則。
- 工作 5：設定網路規則。 
- 工作 6：設定 DNS 伺服器。
- 工作 7：測試防火牆。 

#### <a name="task-1-use-a-template-to-deploy-the-lab-environment"></a>工作 1：使用範本部署實驗室環境。 

在此工作中，您必須檢閱並部署實驗室環境。 

在此工作中，您必須使用 ARM 範本建立虛擬機器。 本實驗室的最後一項練習會使用此虛擬機器。 

1. 登入 Azure 入口網站： **`https://portal.azure.com/`** 。

    >**注意**：登入 Azure 入口網站時使用的帳戶，必須在您用於這個實驗室的 Azure 訂閱中具有「擁有者」或「參與者」角色。

2. 在 Azure 入口網站分頁頂端的 [搜尋資源、服務及文件] 文字輸入框中輸入 **「部署自訂範本」** ，然後按下 **Enter** 鍵。

3. 在 [自訂部署] 刀鋒視窗中按一下 [在編輯器中組建您自己的範本] 選項。

4. 在 [編輯範本] 刀鋒視窗中按一下 [載入檔案]，找出 **\\Allfiles\\Labs\\08\\template.json** 檔案，然後按一下 [開啟]。

    >**注意**：請檢閱範本內容，並注意範本所部署的是裝載 Windows Server 2019 Datacenter 的 Azure VM。

5. 在 [編輯範本] 刀鋒視窗中按一下 [儲存]。

6. 在 [自訂部署] 刀鋒視窗中，確認已指定下列設定 (其他設定請保留預設值)：

   |設定|值|
   |---|---|
   |訂用帳戶|您要在此實驗室中使用的 Azure 訂閱名稱|
   |資源群組|按一下 [新建]，然後輸入以下名稱：**AZ500LAB08**|
   |Location|**(美國) 美國東部**|

    >**注意**：若要找出可以佈建 Azure VM 的 Azure 區域，請參閱 [ **https://azure.microsoft.com/en-us/regions/offers/** ](https://azure.microsoft.com/en-us/regions/offers/)

7. 按一下 [**檢閱 + 建立**]，然後按一下 [**建立**]。

    >**注意**：等待部署完成。 這應該大約需要 2 分鐘的時間。 

#### <a name="task-2-deploy-the-azure-firewall"></a>工作 2：部署 Azure 防火牆

在此工作中，您必須將 Azure 防火牆部署至虛擬網路。 

1. 在 Azure 入口網站分頁頂端的 [搜尋資源、服務及文件] 文字輸入框中輸入 **「防火牆」** ，然後按下 **Enter** 鍵。

2. 在 [防火牆] 刀鋒視窗上，按一下 [+ 建立]。

3. 在 [建立防火牆] 刀鋒視窗的 [基本] 索引標籤上，指定下列設定 (其他設定請保留預設值)：

   |設定|值|
   |---|---|
   |資源群組|**AZ500LAB08**|
   |名稱|**Test-FW01**|
   |區域|**(美國) 美國東部**|
   |防火牆層|**Standard**|
   |防火牆管理|**使用防火牆規則 (傳統) 來管理此防火牆**|
   |選擇虛擬網路|按一下 [使用現有項目] 選項，然後在下拉式清單中選取 [Test-FW-VN]|
   |公用 IP 位址|按一下 [新增] 並在名稱部分輸入 **TEST-FW-PIP**，然後按一下 [確定]|

4. 按一下 [檢閱 + 建立]  ，然後按一下 [建立]  。 

    >**注意**：等待部署完成。 這應該大約需要 5 分鐘的時間。 

5. 在 Azure 入口網站分頁頂端的 [搜尋資源、服務及文件] 文字輸入框中輸入 **「資源群組」** ，然後按下 **Enter** 鍵。

6. 在 [資源群組] 刀鋒視窗的資源群組清單中，按一下 [AZ500LAB08] 項目。

    >**注意**：請在 [AZ500LAB08] 資源群組刀鋒視窗中檢閱資源清單。 您可以依 **型別** 排序。

7. 在資源清單中，按一下代表 **Test-FW01** 防火牆的項目。

8. 在 [Test-FW01] 刀鋒視窗中，找出先前指派給防火牆的 **私人 IP** 位址。 

    >**注意**：下一項工作需要用到這項資訊。


#### <a name="task-3-create-a-default-route"></a>工作 3：建立預設路由

在此工作中，您必須為 **Workload-SN** 子網路建立預設路由。 此路由會設定透過防火牆輸出的流量。

1. 在 Azure 入口網站分頁頂端的 [搜尋資源、服務及文件] 文字輸入框中輸入 **「路由表」** ，然後按下 **Enter** 鍵。

2. 在 [路由表] 刀鋒視窗中按一下 [+ 建立]。

3. 在 [建立路由表] 刀鋒視窗中指定下列設定：

   |設定|值|
   |---|---|
   |資源群組|**AZ500LAB08**|
   |區域| 美國東部|
   |名稱|**防火牆路由**|

4. 按一下 [檢閱 + 建立]，再點選 [建立]，然後等待佈建完成。 

5. 在 [路由表] 刀鋒視窗中按一下 [重新整理]，然後在路由表清單中點選 [防火牆路由] 項目。

6. 在 [防火牆路由] 刀鋒視窗的 [設定] 區段按一下 [子網路]，然後在 [防火牆路由 \| 子網路] 刀鋒視窗中按一下 [+ 關聯]。

7. 在 [關聯子網路] 刀鋒視窗中，指定下列設定：

   |設定|值|
   |---|---|
   |虛擬網路|**Test-FW-VN**|
   |子網路|**Workload-SN**|

    >**注意**：請確定已為此路由選取 **Workload-SN** 子網路，否則防火牆將無法正常運作。

8. 按一下 [確定]，為防火牆和虛擬網路子網路建立關聯。 

9. 返回 [防火牆路由] 刀鋒視窗，在[設定] 區段中按一下 [路由]，然後點選 [+ 新增]。 

10. 在 [新增路由] 刀鋒視窗中，指定下列設定：  

   |設定|值|
   |---|---|
   |路由名稱|**FW-DG**|
   |位址首碼來源|**IP 位址**|
   |來源 IP 位址/CIDR 範圍|**0.0.0.0/0**
   |下一個躍點類型|**虛擬設備**|
   |下一個躍點位址|您在上一項工作中找出的防火牆私人 IP 位址|

    >**注意**：Azure 防火牆實際上是受管理的服務，但虛擬設備可在此情況下運作。
    
11.  按一下 [新增] 新增路由。 


#### <a name="task-4-configure-an-application-rule"></a>工作 4：設定應用程式規則

在此工作中，您必須建立應用程式規則，允許對 `www.bing.com` 的輸出存取。

1. 在Azure 入口網站中，返回 [Test-FW01] 防火牆。

2. 在 [Test-FW01] 刀鋒視窗的 [設定] 區段中，按一下 [規則 (傳統)]。

3. 在 [Test-FW01 \| 規則 (傳統)] 刀鋒視窗中按一下 [應用程式規則集合] 索引標籤，然後點選 [+ 新增應用程式規則集合]。

4. 在 [新增應用程式規則集合] 刀鋒視窗中指定下列設定 (其他設定請保留預設值)：

   |設定|值|
   |---|---|
   |名稱|**App-Coll01**|
   |優先順序|**200**|
   |動作|**允許**|

5. 在 [新增應用程式規則集合] 刀鋒視窗中，使用下列設定在 [目標 FQDN] 區段建立新項目 (其他設定請保留預設值)：

   |設定|值|
   |---|---|
   |NAME|**AllowGH**|
   |來源類型|**IP 位址**|
   |來源|**10.0.2.0/24**|
   |通訊協定連接埠|**http:80、https:443**|
   |目標 FQDN|**www.bing.com**|

6. 按一下 [新增]，新增以目標 FQDN 為基礎的應用程式規則。

    >**注意**：Azure 防火牆包含一組內建規則集合，適用於預設為允許的基礎結構 FQDN。 這些 FQDN 是平台特定的，且無法用於其他用途。 

#### <a name="task-5-configure-a-network-rule"></a>工作 5：設定網路規則

在此工作中，您必須建立網路規則，以允許對連接埠 53 (DNS) 上兩組 IP 位址的輸出存取。

1. 在 Azure 入口網站中，返回 [Test-FW01 \| 規則 (傳統)] 刀鋒視窗。

2. 在 [Test-FW01 \| 規則 (傳統)] 刀鋒視窗中按一下 [網路規則集合] 索引標籤，再點選 [+ 新增網路規則集合]。

3. 在 [新增網路規則集合] 刀鋒視窗中指定下列設定 (其他設定請保留預設值)：

   |設定|值|
   |---|---|
   |名稱|**Net-Coll01**|
   |優先順序|**200**|
   |動作|**允許**|

4. 在 [新增網路規則集合] 刀鋒視窗中，使用下列設定在 [IP 位址] 區段建立新項目 (其他設定請保留預設值)：

   |設定|值|
   |---|---|
   |名稱|**AllowDNS**|
   |通訊協定|**UDP**|
   |來源類型|**IP 位址**|
   |來源位址|**10.0.2.0/24**|
   |目的地類型|**IP 位址**|
   |目的地位址|**209.244.0.3,209.244.0.4**|
   |目的地連接埠|**53**|

5. 按一下 [新增] 新增網路規則。

    >**注意**：此案例使用的目的地位址是已知的公用 DNS 伺服器。 

#### <a name="task-6-configure-the-virtual-machine-dns-servers"></a>工作 6：設定虛擬機器 DNS 伺服器

在此工作中，您必須為虛擬機器設定主要和次要 DNS 位址。 這並非防火牆的需求。 

1. 在Azure 入口網站中，返回 **AZ500LAB08** 資源群組。

2. 在 [AZ500LAB08] 刀鋒視窗的資源清單中，按一下 [Srv-Work] 虛擬機器。

3. 在 [Srv-Work] 刀鋒視窗的 [設定] 區段按一下 [網路]。

4. 在 [Srv-Work \| 網路] 刀鋒視窗中按一下 [網路介面] 項目旁邊的連結。

5. 在網路介面刀鋒視窗的 [設定] 區段按一下 [DNS 伺服器]，選取 [自訂] 選項，然後新增兩個網路規則中參考的 DNS 伺服器：**209.244.0.3** 與 **209.244.0.4**。最後按一下 [儲存] 儲存變更。

6. 返回 [Srv-Work] 虛擬機器分頁。

    >**注意**：請等待更新完成。

    >**注意**：為網路介面更新 DNS 伺服器會自動重新啟動該介面連結的虛擬機器，在適用的情況下也會重新啟動同一個可用性設定組中的所有其他虛擬機器。

#### <a name="task-7-test-the-firewall"></a>工作 7：測試防火牆

在此工作中，您必須測試防火牆，確定其能如預期運作。

1. 在Azure 入口網站中，返回 **AZ500LAB08** 資源群組。

2. 在 [AZ500LAB08] 刀鋒視窗的資源清單中，按一下 [Srv-Work] 虛擬機器。

3. 在 [Srv-Jump] 刀鋒視窗中按一下 [連線]，然後在下拉式功能表中點選 [RDP]。 

4. 按一下 [下載 RDP 檔案]，然後使用該檔案透過遠端桌面連線至 **Srv-Jump** Azure VM。 出現驗證提示時，請提供下列認證：

   |設定|值|
   |---|---|
   |使用者名稱|**localadmin**|
   |密碼|**Pa55w.rd1234**|

    >**注意**：下列步驟須在連線至 **Srv-Jump** Azure VM 的遠端桌面工作階段中執行。 

    >**注意**：您必須連線至 **Srv-Work** 虛擬機器， 這樣才能測試存取 bing.com 網站的能力。  

5. 在連線至 **Srv-Jump** 的遠端桌面工作階段中，以滑鼠右鍵按一下 [開始]，然後在右鍵功能表中點選 [執行]。在 [執行] 對話方塊中執行下列命令，以連線至 **Srv-Work**。 

    ```
    mstsc /v:Srv-Work
    ```

6. 出現驗證提示時，請提供下列認證：

   |設定|值|
   |---|---|
   |使用者名稱|**localadmin**|
   |密碼|**Pa55w.rd1234**|

    >**注意**：請等候遠端桌面工作階段建立完成並載入伺服器管理員介面。

7. 在連線至 **Srv-Work** 的遠端桌面工作階段中，於 [伺服器管理員] 內按一下 [本機伺服器]，然後點選 [IE 增強式安全性設定]。

8. 在 [Internet Explorer 增強式安全性設定] 對話方塊中將兩個選項都設定為 [關閉]，然後按一下 [確定]。

9. 在連線至 **Srv-Work** 的遠端桌面工作階段中啟動 Internet Explorer，並瀏覽至 **`https://www.bing.com`** 。 

    >**注意**：網站應能順利顯示。 防火牆會允許您存取網站。

10. 瀏覽至 **`http://www.microsoft.com/`**

    >**注意**：在瀏覽器分頁中，您會收到類似下列文字的訊息：`HTTP request from 10.0.2.4:xxxxx to microsoft.com:80. Action: Deny. No rule matched. Proceeding with default action.` 這是預料中的情況，因為防火牆封鎖了對這個網站的存取。 

11. 終止這兩個遠端桌面工作階段。

> 結果：您已順利設定並測試 Azure 防火牆。

**清除資源**

> 請記得移除您不再使用的任何新建 Azure 資源。 移除未使用的資源可避免產生非預期的費用。 

1. 在 Azure 入口網站中按一下右上方的第一個圖示，開啟 Cloud Shell。 如果出現提示，請點選 [PowerShell] 與 [建立儲存體]。

2. 確定在 [Cloud Shell] 窗格左上角的下拉式功能表中，已選取 [PowerShell]。

3. 在 [Cloud Shell] 窗格的 PowerShell 工作階段中執行下列指令，移除您在此實驗室中建立的資源群組：
  
    ```powershell
    Remove-AzResourceGroup -Name "AZ500LAB08" -Force -AsJob
    ```
4. 關閉 [Cloud Shell] 窗格。 
